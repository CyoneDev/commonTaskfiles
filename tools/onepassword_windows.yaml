# https://taskfile.dev

version: '3'

tasks:
  install:
    cmds:
      - scoop install 1password-cli
    status: 
      - command -v op.exe

  check-token-exists:
    preconditions:
      - sh: '[[ ! -z "$OP_SERVICE_ACCOUNT_TOKEN" ]]'
        msg: "OP_SERVICE_ACCOUNT_TOKEN is not set. Please set it in your environment variables."
  
  check-token-valid:
    deps: [check-token-exists]
    preconditions:
      - sh: 'op whoami'
        msg: 'Token is invalid. Please check the "OP_SERVICE_ACCOUNT_TOKEN" environment variable to ensure its valid.'

  inject-templates:
    desc: "Inject templates in the given directory"
    vars:
      DIR:
        description: "Directory containing .tpl files"
        default: "."
    cmds:
      - |
        for TPL_FILE in $(find {{.DIR}} -type f -name '*.tpl'); do
          OUTPUT_FILE="${TPL_FILE%.tpl}"
          op inject -i "$TPL_FILE" -o "$OUTPUT_FILE" --force
        done
    silent: true