# https://taskfile.dev

version: '3'

tasks:
  install:
    cmds:
      - scoop install 1password-cli
    status: 
      - command -v op.exe

  set-token:
    deps: [install]
    desc: Uses 1pass to inject variables into .env.tpl secret file
    cmds:
      - op inject -i secrets/.env.tpl -o secrets/.env --force
    status:
      - task check-token-valid
    silent: true

  check-token-exists:
    preconditions:
      - sh: '[[ ! -z "$OP_SERVICE_ACCOUNT_TOKEN" ]]'
        msg: "OP_SERVICE_ACCOUNT_TOKEN is not set. Please set it in your environment variables."
  
  check-token-valid:
    deps: [check-token-exists]
    preconditions:
      - sh: 'op whoami'
        msg: 'Token is invalid. Please check the "OP_SERVICE_ACCOUNT_TOKEN" environment variable to ensure its valid.'