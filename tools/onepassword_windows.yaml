# https://taskfile.dev

version: '3'

tasks:
  install:
    cmds:
      - scoop install 1password-cli
    status: 
      - command -v op.exe

  check-token-exists:
    preconditions:
      - sh: '[[ ! -z "$OP_SERVICE_ACCOUNT_TOKEN" ]]'
        msg: "OP_SERVICE_ACCOUNT_TOKEN is not set. Please set it in your environment variables."
  
  check-token-valid:
    deps: [check-token-exists]
    preconditions:
      - sh: 'op whoami'
        msg: 'Token is invalid. Please check the "OP_SERVICE_ACCOUNT_TOKEN" environment variable to ensure its valid.'

  inject-secrets:
    desc: "Inject templates in the given directory"
    cmds:
      - |
        pwsh -Command '
          Get-ChildItem -Path $DIR -Filter *.tpl -File | ForEach-Object {
            $tplFile = $_.FullName
            $outputFile = $tplFile -replace "\.tpl`$", ""
            op inject -i $tplFile -o $outputFile --force
          }
        '
    silent: true
    dir: "{{.DIR}}"
    vars:
      DIR: "{{.SECRETS_DIR}}"