# https://taskfile.dev
version: '3'

tasks:
  install:
    cmds:
      - scoop install 1password-cli
    status: 
      - command -v op.exe

  check-token-exists:
    preconditions:
      - sh: '[[ ! -z "$OP_SERVICE_ACCOUNT_TOKEN" ]]'
        msg: "OP_SERVICE_ACCOUNT_TOKEN is not set. Please set it in your environment variables."
  
  check-token-valid:
    deps: [check-token-exists]
    preconditions:
      - sh: 'op whoami'
        msg: 'Token is invalid. Please check the "OP_SERVICE_ACCOUNT_TOKEN" environment variable to ensure its valid.'

  inject-secrets:
    desc: "Inject templates in the given directory"
    cmds:
      - |
        pwsh -Command '
          Get-ChildItem -Path $DIR -Filter *.tpl -File | ForEach-Object {
            $tplFile = $_.FullName
            $outputFile = $tplFile -replace "\.tpl`$", ""
            op inject -i $tplFile -o $outputFile --force
          }
        '
    silent: true
    dir: "{{.DIR}}"
    vars:
      DIR: "{{.SECRETS_DIR}}"

  set-secrets:
    desc: "Ensure 1Password CLI is installed and OP_SERVICE_ACCOUNT_TOKEN is set. Inject secrets into .env file."
    deps: [install]
    cmds:
      - echo "{{.GREETING}} You are on {{OS}}"
      - task check-token-valid #not calling it with task: because i need it to initialize a new shell to load the .env file that was generated by the previous command 
      - task inject-secrets -- DIR "{{.SECRETS_DIR}}"
